upstream auth {
    server 127.0.0.1:9213;
    keepalive 20;
    keepalive_timeout 24h;
}

underscores_in_headers on;
proxy_pass_request_headers      on;

server {
    listen 	8085;
    server_name localhost;

    root /home/andrey/projects/neurokids/static;

    location /adminka {
        try_files /html/courseAdmin.html =404;
    }

    location = / {
        rewrite / /neurokids last;
    }

    location /neurokids {
        proxy_pass http://localhost:6670;
    }
    location /courses {
        auth_request /auth;
        auth_request_set $perm $upstream_http_x_perm;
        auth_request_set $user_id $upstream_http_x_user_id;
        proxy_set_header x-perm $perm;
        proxy_set_header x-user-id $user_id;

        proxy_pass http://localhost:6670;
    }
    location /cours {
        auth_request /auth;
        auth_request_set $perm $upstream_http_x_perm;
        auth_request_set $user_id $upstream_http_x_user_id;
        proxy_set_header x-perm $perm;
        proxy_set_header x-user-id $user_id;

        proxy_pass http://localhost:6670;
    }
    location /chat {
        auth_request /auth;
        auth_request_set $perm $upstream_http_x_perm;
        auth_request_set $user_id $upstream_http_x_user_id;
        proxy_set_header x-perm $perm;
        proxy_set_header x-user-id $user_id;

        proxy_pass http://localhost:6670;
    }
    location /diagnostic {
        proxy_pass http://localhost:6670;
    }
    location /setting {
        auth_request /auth;
        auth_request_set $perm $upstream_http_x_perm;
        auth_request_set $user_id $upstream_http_x_user_id;
        proxy_set_header x-perm $perm;
        proxy_set_header x-user-id $user_id;

        proxy_pass http://localhost:6670;
    }
    location /userList {
        proxy_pass http://localhost:6670;
    }
    location /userCreate {
        proxy_pass http://localhost:6670;
    }
    location /learn {
        proxy_pass http://localhost:6670;
    }
    location /dgComplecs {
        proxy_pass http://localhost:6670;
    }
    location /contacts {
        proxy_pass http://localhost:6670;
    }

    location /getAllUsers {
        auth_request /auth;
        auth_request_set $perm $upstream_http_x_perm;
        auth_request_set $user_id $upstream_http_x_user_id;
        proxy_set_header x-perm $perm;
        proxy_set_header x-user-id $user_id;

        proxy_pass http://localhost:6666;
    }

    location /getMe {
        auth_request /auth;
        auth_request_set $perm $upstream_http_x_perm;
        auth_request_set $user_id $upstream_http_x_user_id;
        proxy_set_header x-perm $perm;
        proxy_set_header x-user-id $user_id;

        proxy_pass http://localhost:6667;
    }

    location /getUserById {
        auth_request /auth;
        auth_request_set $perm $upstream_http_x_perm;
        auth_request_set $user_id $upstream_http_x_user_id;
        proxy_set_header x-perm $perm;
        proxy_set_header x-user-id $user_id;

        proxy_pass http://localhost:6668;
    }

    location /updatePassword {
        auth_request /auth;
        auth_request_set $perm $upstream_http_x_perm;
        auth_request_set $user_id $upstream_http_x_user_id;
        proxy_set_header x-perm $perm;
        proxy_set_header x-user-id $user_id;

        proxy_pass http://localhost:6569;
    }

    location /updateInfo {
        auth_request /auth;
        auth_request_set $perm $upstream_http_x_perm;
        auth_request_set $user_id $upstream_http_x_user_id;
        proxy_set_header x-perm $perm;
        proxy_set_header x-user-id $user_id;

        proxy_pass http://localhost:6570;
    }

    # location / {
    #     set            $memcached_key "$uri";
    #     memcached_pass localhost:11211;
    # }

    location ~* ^/static/(css|js|html|svg|picture)/ {
        root /home/andrey/projects/neurokids;
    }

    location ~* ^/images/(\d+)/(.*)\.(jpg|jpeg|png|webp)$ {
        try_files $uri @generate_image;
        expires 30m;
    }

    location /updateImage {
        proxy_pass http://localhost:7700;
    }

    location @generate_image {
        proxy_pass http://localhost:7700;
    }

    # Auth api

    location = /auth {
        proxy_pass http://auth/;
        proxy_pass_request_body off;
        proxy_set_header Content-Length "";
        proxy_set_header X-Original-URI $request_uri;
        proxy_http_version 1.1;
        proxy_set_header Connection "";
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_set_header X-Request-Id $request_id;
    }

    location /login {
        proxy_pass http://localhost:9212;
    }

    location /logout {
        proxy_pass http://localhost:9211;
    }

    # Filesharing api

    location /uploadFiles {
        client_max_body_size 333M;

        proxy_pass http://localhost:7000;
    }
    
    location /getAllFiles {
        proxy_pass http://localhost:7010;
    }

    location /getFileById {
        proxy_pass http://localhost:7011;
    }

    location /getFileByPath {
        proxy_pass http://localhost:7012;
    }

    location /getFileInfoById {
        proxy_pass http://localhost:7013;
    }
    
    location /updateFile {
        client_max_body_size 333M;
        
        proxy_pass http://localhost:7020;
    }

    location /upsertFileByPath {
        client_max_body_size 333M;

        proxy_pass http://localhost:7021;
    }

    location /updateFilePathById {
        proxy_pass http://localhost:7022;
    }

    # Chat api

    # chat_ws       tcp:7130

    location /openChatWs {
        auth_request /auth;
        auth_request_set $perm $upstream_http_x_perm;
        auth_request_set $user_id $upstream_http_x_user_id;
        proxy_set_header x-perm $perm;
        proxy_set_header x-user-id $user_id;

        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "upgrade";

        proxy_pass http://localhost:7130;
    }

    # chat_create_chat   tcp:7100
    # chat_get_chats     tcp:7110
    # chat_update_chat   tcp:7120

    location /createChat {
        proxy_pass http://localhost:7100;
    }

    location /getChats {
        auth_request /auth;
        auth_request_set $perm $upstream_http_x_perm;
        auth_request_set $user_id $upstream_http_x_user_id;
        proxy_set_header x-perm $perm;
        proxy_set_header x-user-id $user_id;

        proxy_pass http://localhost:7110;
    }

    location /updateChat {
        proxy_pass http://localhost:7120;
    }

    # chat_add_message  tcp:7105
    # chat_get_messages tcp:7115

    location /addMessage {
        proxy_pass http://localhost:7105;
    }

    location /getMessages {
        auth_request /auth;
        auth_request_set $perm $upstream_http_x_perm;
        auth_request_set $user_id $upstream_http_x_user_id;
        proxy_set_header x-perm $perm;
        proxy_set_header x-user-id $user_id;
        
        proxy_pass http://localhost:7115;
    }

    # Course api

    # course_page_create_course_meta         tcp:7200
    # course_page_get_all_course_metas       tcp:7210
    # course_page_get_all_short_cards        tcp:7211
    # course_page_get_full_card_by_id        tcp:7212
    # course_page_get_full_course_meta_by_id tcp:7213
    # course_page_update_full_course_meta    tcp:7220
    # course_page_update_course_meta    tcp:7221
    # course_page_update_course_short_card   tcp:7222
    # course_page_update_course_full_card    tcp:7223

    location /createCourseMeta {
        proxy_pass http://localhost:7200;
    }

    location /getAllCourseMetas {
        proxy_pass http://localhost:7210;
    }

    location /getAllShortCourseCards {
        proxy_pass http://localhost:7211;
    }

    location /getFullCourseCardById {
        proxy_pass http://localhost:7212;
    }

    location /getFullCourseMetaById {
        proxy_pass http://localhost:7213;
    }

    location /updateFullCourseMeta {
        proxy_pass http://localhost:7220;
    }

    location /updateCourseMeta {
        proxy_pass http://localhost:7221;
    }

    location /updateCourseShortCard {
        proxy_pass http://localhost:7222;
    }

    location /updateCourseFullCard {
        proxy_pass http://localhost:7223;
    }

    # course_create_course    tcp:7300
    # course_get_all_courses  tcp:7310
    # course_get_course_by_id tcp:7311
    # course_update_course    tcp:7320

    location /createCourse {
        proxy_pass http://localhost:7300;
    }

    location /getAllCourses {
        proxy_pass http://localhost:7310;
    }

    location /getCourseById {
        proxy_pass http://localhost:7311;
    }

    location /updateCourse {
        proxy_pass http://localhost:7320;
    }

    # course_user_create_course_user           tcp:7400
    # course_user_get_all_course_user          tcp:7410
    # course_user_get_course_user_by_course_id tcp:7411
    # course_user_update_course_user           tcp:7420

    location /createCourseUser {
        auth_request /auth;
        auth_request_set $perm $upstream_http_x_perm;
        auth_request_set $user_id $upstream_http_x_user_id;
        proxy_set_header x-perm $perm;
        proxy_set_header x-user-id $user_id;

        proxy_pass http://localhost:7400;
    }

    location /getAllCourseUser {
        auth_request /auth;
        auth_request_set $perm $upstream_http_x_perm;
        auth_request_set $user_id $upstream_http_x_user_id;
        proxy_set_header x-perm $perm;
        proxy_set_header x-user-id $user_id;
        
        proxy_pass http://localhost:7410;
    }

    location /getCourseUserByCourseId {
        if ($request_method = OPTIONS) {
            return 204;
        }
        auth_request /auth;
        auth_request_set $perm $upstream_http_x_perm;
        auth_request_set $user_id $upstream_http_x_user_id;
        proxy_set_header x-perm $perm;
        proxy_set_header x-user-id $user_id;
        

        proxy_pass http://localhost:7411;
    }

    location /updateCourseUser {
        if ($request_method = OPTIONS) {
            return 204;
        }
        auth_request /auth;
        auth_request_set $perm $upstream_http_x_perm;
        auth_request_set $user_id $upstream_http_x_user_id;
        proxy_set_header x-perm $perm;
        proxy_set_header x-user-id $user_id;
        
        
        proxy_pass http://localhost:7420;
    }

    # Test api

    # test_create_test    tcp:7500
    # test_get_all_tests  tcp:7510
    # test_get_test_by_id tcp:7511
    # test_update_test    tcp:7520

    location /createTest {
        proxy_pass http://localhost:7500;
    }

    location /getAllTests {
        proxy_pass http://localhost:7510;
    }

    location /getTestById {
        proxy_pass http://localhost:7511;
    }

    location /updateTest {
        proxy_pass http://localhost:7520;
    }

    # test_user_create_test_user         tcp:7600
    # test_user_get_all_test_user        tcp:7610
    # test_user_get_test_user_by_test_id tcp:7611
    # test_user_update_test_user         tcp:7620

    location /createTestUser {
        auth_request /auth;
        auth_request_set $perm $upstream_http_x_perm;
        auth_request_set $user_id $upstream_http_x_user_id;
        proxy_set_header x-perm $perm;
        proxy_set_header x-user-id $user_id;

        proxy_pass http://localhost:7600;
    }

    location /getAllTestUser {
        auth_request /auth;
        auth_request_set $perm $upstream_http_x_perm;
        auth_request_set $user_id $upstream_http_x_user_id;
        proxy_set_header x-perm $perm;
        proxy_set_header x-user-id $user_id;
        
        proxy_pass http://localhost:7610;
    }

    location /getTestUserByTestId {
        if ($request_method = OPTIONS) {
            return 204;
        }
        auth_request /auth;
        auth_request_set $perm $upstream_http_x_perm;
        auth_request_set $user_id $upstream_http_x_user_id;
        proxy_set_header x-perm $perm;
        proxy_set_header x-user-id $user_id;
        

        proxy_pass http://localhost:7611;
    }

    location /updateTestUser {
        if ($request_method = OPTIONS) {
            return 204;
        }
        auth_request /auth;
        auth_request_set $perm $upstream_http_x_perm;
        auth_request_set $user_id $upstream_http_x_user_id;
        proxy_set_header x-perm $perm;
        proxy_set_header x-user-id $user_id;
        
        
        proxy_pass http://localhost:7620;
    }
}